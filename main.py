import telebot
from telebot import types
import random
from models import User, Word, UserWord
from database import session, init_db
from config import TOKEN

bot = telebot.TeleBot(TOKEN)
user_states = {}


# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
def main_markup():
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("üéì –ò–∑—É—á–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π", "üìù –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ", "‚ÑπÔ∏è –ü–æ–º–æ—â—å")
    return markup


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç–∞—Ä—Ç–∞
@bot.message_handler(commands=["start"])
def start(message):
    user = session.query(User).filter_by(telegram_id=message.from_user.id).first()
    if not user:
        user = User(
            telegram_id=message.from_user.id,
            username=message.from_user.username
        )
        session.add(user)
        session.commit()

        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω—ã
        init_db()

    bot.send_message(
        message.chat.id,
        "–ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π —É—á–∏—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π!",
        reply_markup=main_markup()
    )


# –ü–æ–º–æ—â—å
@bot.message_handler(func=lambda m: m.text == "‚ÑπÔ∏è –ü–æ–º–æ—â—å")
def help(message):
    text = (
        "üìö –≠—Ç–æ –±–æ—Ç –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤.\n\n"
        "üéì –ù–∞–∂–º–∏ '–ò–∑—É—á–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π' –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏\n"
        "üìù –ò—Å–ø–æ–ª—å–∑—É–π '–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ' –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–ª–æ–≤\n"
        "‚ÑπÔ∏è –ó–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø—Ä–∞–≤–∫—É –æ —Ñ—É–Ω–∫—Ü–∏—è—Ö –±–æ—Ç–∞"
    )
    bot.send_message(message.chat.id, text)


# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ–≤–∞
@bot.message_handler(func=lambda m: m.text == "üìù –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ")
def add_word(message):
    msg = bot.send_message(message.chat.id, "–í–≤–µ–¥–∏ —Å–ª–æ–≤–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º:")
    bot.register_next_step_handler(msg, process_english)


def process_english(message):
    user_states[message.from_user.id] = {"english": message.text}
    msg = bot.send_message(message.chat.id, "–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏ –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–æ–º:")
    bot.register_next_step_handler(msg, process_russian)


def process_russian(message):
    user_id = message.from_user.id
    english = user_states[user_id]["english"]
    russian = message.text

    user = session.query(User).filter_by(telegram_id=user_id).first()

    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–ª–æ–≤–æ
    new_word = Word(english=english, russian=russian)
    session.add(new_word)
    session.commit()

    # –°–≤—è–∑—ã–≤–∞–µ–º —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    user_word = UserWord(user_id=user.id, word_id=new_word.id)
    session.add(user_word)
    session.commit()

    del user_states[user_id]
    bot.send_message(message.chat.id, "‚úÖ –°–ª–æ–≤–æ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!", reply_markup=main_markup())


# –û–±—É—á–µ–Ω–∏–µ
@bot.message_handler(func=lambda m: m.text == "üéì –ò–∑—É—á–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π")
def study(message):
    user = session.query(User).filter_by(telegram_id=message.from_user.id).first()
    words = (
        session.query(Word)
        .join(UserWord, isouter=True)
        .filter((UserWord.user_id == user.id) | (UserWord.user_id == None))
        .filter(UserWord.learned == False)
        .order_by(func.random())
        .limit(4)
        .all()
    )

    if not words:
        bot.send_message(message.chat.id, "–¢—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–∏–ª –Ω–∏ –æ–¥–Ω–æ–≥–æ —Å–ª–æ–≤–∞ üò¢")
        return

    correct = words[0].russian

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
    wrong = random.sample([w.russian for w in words[1:]], 3)
    options = [correct] + wrong
    random.shuffle(options)

    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    for opt in options:
        markup.add(types.KeyboardButton(opt))

    user_states[message.from_user.id] = {
        "word_id": words[0].id,
        "correct": correct,
        "attempts": 0
    }

    bot.send_message(
        message.chat.id,
        f"–ö–∞–∫ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å–ª–æ–≤–æ: **{words[0].english}**?",
        parse_mode="Markdown",
        reply_markup=markup
    )


# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞
@bot.message_handler(func=lambda m: m.from_user.id in user_states)
def check_answer(message):
    user_id = message.from_user.id
    data = user_states[user_id]

    if message.text == data["correct"]:
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        user_word = (
            session.query(UserWord)
            .filter_by(
                user_id=session.query(User.id).filter_by(telegram_id=user_id).scalar(),
                word_id=data["word_id"]
            )
            .first()
        )
        user_word.correct_attempts += 1

        if user_word.correct_attempts >= 3:
            user_word.learned = True
            session.commit()
            bot.send_message(message.chat.id, "üéâ –°–ª–æ–≤–æ –≤—ã—É—á–µ–Ω–æ!", reply_markup=main_markup())
        else:
            session.commit()
            bot.send_message(message.chat.id, "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ! –ï—â–µ —Ä–∞–∑–æ–∫?", reply_markup=main_markup())

        del user_states[user_id]
    else:
        data["attempts"] += 1
        if data["attempts"] >= 2:
            bot.send_message(
                message.chat.id,
                f"‚ùå –ù–µ–≤–µ—Ä–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {data['correct']}",
                reply_markup=main_markup()
            )
            del user_states[user_id]
        else:
            bot.send_message(message.chat.id, "üòï –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑:")


if __name__ == "__main__":
    print('bot is running')
    bot.infinity_polling()